{% extends "base_generic.html" %}

{% block content %}
    <h1 class="page-title">Schedules</h1>
    <a href="{% url 'create_schedule' %}" class="add-new-button" style="margin-bottom: 2rem;">+ New</a>
    <form id="bulkActionForm" method="post" action="{% url 'schedules_bulk_action_confirm' %}">
        {% csrf_token %}
        <div class="list-button-container">
            <div class="search-container">
                <label for="searchInput" style="align-self: center; width: 52px;">Search:</label>
                <input type="text" id="searchInput" placeholder="Search schedule..." class="search-bar">
            </div>
            <div class="action-container">
                <label for="action" style="align-self: center; width: 52px;">Action:</label>
                <select id="action" class="action-selection" name="action">
                    <option selected value="" disabled>Select action</option>
                    <option value="delete">Delete</option>
                </select>
                <button type="button" class="action-button">Go</button>
            </div>
        </div>
        {% if schedule_list %}
            <table class="inst-table">
                <colgroup>
                    <col class="inst-id-column">
                    <col class="inst-name-column">
                    <col class="inst-checkbox-column">
                </colgroup>
                <thead>
                    <tr class="inst-table-header-row">
                        <th class="inst-table-data"><b>ID</b></th>
                        <th class="inst-table-data"><b>Schedule Period</b></th>
                        <th class="inst-table-data"><input type="checkbox" id="headerCheckbox" style="align-self: center;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for schedule in schedule_list %}
                        <tr class="inst-table-data-row">                       
                            <td class="inst-table-data">{{schedule.id}}</td>
                            <td class="inst-table-data"><a href="{{ schedule.get_absolute_url }}" class="inst-detail-link">{{schedule}}</a></td>
                            <td class="inst-table-data">
                                <input name="selected" type="checkbox" class="row-checkbox" value="{{ schedule.id }}" style="align-self: center;">
                            </td>                                 
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>There are no schedules.</p>
        {% endif %}
    </form>

    <script>
        const searchInput = document.getElementById('searchInput');
        const tableRows = document.querySelectorAll('.inst-table-data-row');

        searchInput.addEventListener('input', function (e) {
            const query = e.target.value.toLowerCase();

            tableRows.forEach(row => {
                const nameCell = row.querySelector('.inst-table-data:nth-child(2)');
                const nameText = nameCell.textContent.toLowerCase();

                // Show/hide row based on match
                if (nameText.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        const headerCheckbox = document.getElementById('headerCheckbox');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox')
        
        headerCheckbox.addEventListener('change', function () {
            rowCheckboxes.forEach(cb => {
                if (cb.closest('tr').style.display !== 'none') {
                    cb.checked = headerCheckbox.checked;
                }
            });
        });

        document.querySelector('.action-button').addEventListener('click', function () {
            const form = document.getElementById('bulkActionForm');
            const selected = document.querySelectorAll('.row-checkbox:checked');
            const action = document.getElementById('action')

            if (selected.length === 0) {
                alert('Please select at least 1 schedule.')
                return;
            };

            if (!action.value) {
                alert('Please select an action.');
                return;
            }            
            
            form.submit();
        });
    
    </script>
{% endblock %}